name: publish-github-packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: ledgerdb
  BIN_NAME: ledgerdb
  PACKAGE_DIR: packages/sdk-typescript

jobs:
  build-test:
    name: Build & Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - run: go test ./...

  build-linux-windows:
    name: Build Linux + Windows
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Build binaries
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          for GOOS in linux windows; do
            for GOARCH in amd64 arm64; do
              ext=""
              if [ "$GOOS" = "windows" ]; then ext=".exe"; fi
              echo "Building $GOOS/$GOARCH"
              CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH"                 go build -trimpath -ldflags "-s -w"                 -o "dist/${BIN_NAME}-${GOOS}-${GOARCH}${ext}"                 ./cmd/ledgerdb
            done
          done
      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-windows
          path: dist/*

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: build-test
    env:
      APPLE_DEV_ID_P12_BASE64: ${{ secrets.APPLE_DEV_ID_P12_BASE64 }}
      APPLE_DEV_ID_P12_PASSWORD: ${{ secrets.APPLE_DEV_ID_P12_PASSWORD }}
      APPLE_KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
      SIGNING_IDENTITY: ${{ secrets.SIGNING_IDENTITY }}
      APPLE_NOTARY_API_KEY_BASE64: ${{ secrets.APPLE_NOTARY_API_KEY_BASE64 }}
      APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
      APPLE_NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Build binaries
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          for GOARCH in amd64 arm64; do
            echo "Building darwin/$GOARCH"
            CGO_ENABLED=0 GOOS=darwin GOARCH="$GOARCH"               go build -trimpath -ldflags "-s -w"               -o "dist/${BIN_NAME}-darwin-${GOARCH}"               ./cmd/ledgerdb
          done
      - name: Import Developer ID cert
        if: env.APPLE_DEV_ID_P12_BASE64 != ''
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' "$APPLE_DEV_ID_P12_BASE64" | base64 --decode > /tmp/dev_id.p12 2>/dev/null ||           printf '%s' "$APPLE_DEV_ID_P12_BASE64" | base64 -d        > /tmp/dev_id.p12 2>/dev/null ||           printf '%s' "$APPLE_DEV_ID_P12_BASE64" | /usr/bin/base64 -D > /tmp/dev_id.p12
          security create-keychain -p "$APPLE_KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$APPLE_KEYCHAIN_PASSWORD" build.keychain
          security import /tmp/dev_id.p12 -k build.keychain -P "$APPLE_DEV_ID_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s build.keychain login.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "$APPLE_KEYCHAIN_PASSWORD" build.keychain
      - name: Codesign binaries
        if: env.APPLE_DEV_ID_P12_BASE64 != '' && env.SIGNING_IDENTITY != ''
        shell: bash
        run: |
          set -euo pipefail
          codesign --force --options runtime --timestamp --sign "$SIGNING_IDENTITY" "dist/${BIN_NAME}-darwin-amd64"
          codesign --force --options runtime --timestamp --sign "$SIGNING_IDENTITY" "dist/${BIN_NAME}-darwin-arm64"
          codesign --verify --verbose=2 "dist/${BIN_NAME}-darwin-amd64"
          codesign --verify --verbose=2 "dist/${BIN_NAME}-darwin-arm64"
      - name: Notarize binaries
        if: env.APPLE_NOTARY_API_KEY_BASE64 != '' && env.APPLE_NOTARY_KEY_ID != '' && env.APPLE_NOTARY_ISSUER_ID != '' && env.APPLE_TEAM_ID != ''
        shell: bash
        run: |
          set -euo pipefail
          KEY_PATH="/tmp/AuthKey_${APPLE_NOTARY_KEY_ID}.p8"
          printf '%s' "$APPLE_NOTARY_API_KEY_BASE64" | base64 --decode > "$KEY_PATH" 2>/dev/null || \
          printf '%s' "$APPLE_NOTARY_API_KEY_BASE64" | base64 -d        > "$KEY_PATH" 2>/dev/null || \
          printf '%s' "$APPLE_NOTARY_API_KEY_BASE64" | /usr/bin/base64 -D > "$KEY_PATH"

          for bin in dist/${BIN_NAME}-darwin-amd64 dist/${BIN_NAME}-darwin-arm64; do
            zip="${bin}.zip"
            ditto -c -k --sequesterRsrc --keepParent "$bin" "$zip"
            xcrun notarytool submit "$zip" \
              --key "$KEY_PATH" \
              --key-id "$APPLE_NOTARY_KEY_ID" \
              --issuer "$APPLE_NOTARY_ISSUER_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --wait
            xcrun stapler staple -v "$bin"
            xcrun stapler validate "$bin"
            rm -f "$zip"
          done
      - uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          path: dist/*

  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux-windows, build-macos]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Checksums
        shell: bash
        run: |
          set -euo pipefail
          shasum -a 256 dist/* > dist/SHA256SUMS.txt
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-github-packages:
    name: Publish GitHub Packages
    runs-on: ubuntu-latest
    needs: release
    defaults:
      run:
        working-directory: packages/sdk-typescript
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://npm.pkg.github.com"
      - run: npm ci --ignore-scripts
        env:
          LEDGERDB_SKIP_DOWNLOAD: "1"
      - run: npm version ${GITHUB_REF_NAME#v} --no-git-tag-version
        shell: bash
      - run: npm run build
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
